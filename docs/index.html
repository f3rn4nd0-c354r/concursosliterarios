<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ’ Concursos LiterÃ¡rios em PortuguÃªs</title>

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.0/dist/bootstrap-vue.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="app">
        <h1 class="page-title">Concursos LiterÃ¡rios em PortuguÃªs âœ’</h1>
        <b-container id="top">
            <b-row>
                <b-col id="table-filter">
                    <!-- Content for the first div (takes up half of the screen on medium and larger screens) -->
                    Filtrar por
                    <ul>
                        <li>
                            <p> idade. Tenho <input v-model="ageFilter" type="text" class="form-contro"> anos.
                            </p>
                        </li>
                        <li>
                            <p> gÃ©nero. Escrevo <input v-model="genreFilter" type="text" class="form-control"
                                    placeholder="conto/poesia/romance">.</p>
                        </li>
                    </ul>
                </b-col>
                <b-col id="contribute-data">
                    <!-- Content for the second div (takes up half of the screen on medium and larger screens) -->
                    <p>Se conhece algum concurso que nÃ£o aparece na lista, indique-nos <a
                            href="https://forms.gle/8CUyHjLePvtXu1T58" target="_blank">aqui</a>.</p>

                </b-col>
            </b-row>
        </b-container>

        <b-table id="main-table" striped hover :items="filteredUsuarios" :fields="tableFields"
            :sort-by="currentSortColumn" label-sort-asc="Ordenar ðŸ¡…" label-sort-desc="Ordenar ðŸ¡‡"
            label-sort-clear="desordenar" no-sort-reset class="table-striped" :sort-compare="sortingChanged" foot-clone>
            <template #cell(titulo)="data">
                <span v-html="data.item.titulo"></span>
              </template>
            <template #cell(website)="data">
                <b-link :href="data.item.website" target="_blank">ver website</b-link>
            </template>
            <template #cell(regulamento)="data">
                <b-link :href="data.item.regulamento" target="_blank">ver regulamento</b-link>
            </template>
            <template #cell(prazo)="data">
                {{data.item.prazo}}
            </template>
            <template #cell(tempoRestante)="data">
                {{data.item.tempoRestante}} dias
            </template>
        </b-table>
    </div>


    <!-- Include the BootstrapVue app -->
    <script src="data.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    usuarios: usuarios,
                    ageFilter: '',
                    genreFilter: '',
                    currentSortColumn: "prazo",
                    tableFields: [
                        { key: 'titulo', label: 'TÃ­tulo', sortable: true, tdClass: 'no-splitting pre-wrap locked-column' },
                        { key: 'concorrente', label: 'Concorrente' },
                        { key: 'idade', label: 'Idade', tdClass: 'no-splitting' },
                        { key: 'obra', label: 'Requisitos da obra' },
                        { key: 'tema', label: 'Tema' },
                        { key: 'multiplas', label: 'MÃºltiplas participaÃ§Ãµes' },
                        { key: 'dimensao', label: 'DimensÃ£o' },
                        { key: 'premio', label: 'PrÃ©mio', sortable: true },
                        { key: 'entrega', label: 'Forma de entrega' },
                        { key: 'prazo', label: 'Prazo', sortable: true, tdClass: 'no-splitting' },
                        { key: 'tempoRestante', label: 'Faltam', sortable: true, thClass: 'no-splitting', tdClass: 'no-splitting' },
                        { key: 'obs', label: 'Obs.' },
                        { key: 'website', label: 'Website' },
                        { key: 'regulamento', label: 'Regulamento' },
                    ],
                };
            },
            methods: {
                sortingChanged(a, b, key) {
                    let newKey = key;
                    switch(key) {
                        case 'premio':
                            newKey = '1premio';
                            break;
                        // case 'idade':
                        //     newKey = 'id_max';
                        //     break;
                        default:
                            return false;
                    }
                    return a[newKey] - b[newKey];
                },
            },
            computed: {
                filteredUsuarios: function () {

                    usuarios.map(

                        item => {
                            // calculate days available to write
                            const pad = (n, s = 2) => (`${new Array(s).fill(0)}${n}`).slice(-s);

                            let d = new Date(item.prazo);
                            d.setHours(0, 0, 0, 0);
                            let dNow = new Date();
                            dNow.setHours(0, 0, 0, 0);
                            const diffTime = Math.abs(d - dNow);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            item.tempoRestante = diffDays;
                            // fomat prazo date
                            item.prazo = `${pad(d.getFullYear(), 4)}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

                            d = new Date(item.resultado);
                            if (!isNaN(d)) {
                                item.resultado = `${pad(d.getFullYear(), 4)}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
                            }

                            // convert sort key columns to int
                            for (column in ['id_max', "1premio"]) {
                                item.column = parseInt(item.column);
                            }

                            // 
                            item.titulo = item.titulo.replace('\n', '<br>');

                        }
                    )

                    return this.usuarios
                        .filter(usuario => {
                            if (!this.ageFilter) {
                                return true;
                            }
                            let minAge = parseInt(usuario.id_min) || 0;
                            let maxAge = parseInt(usuario.id_max) || 150;
                            let writerAge = parseInt(this.ageFilter);
                            return writerAge >= minAge && writerAge <= maxAge;
                        })
                        .filter(usuario => {
                            if (usuario.obra.trim() == "") {
                                return true;
                            }
                            return usuario.obra.toLowerCase().includes(this.genreFilter.toLowerCase());
                        })
                },
            }
        });
    </script>
</body>

</html>