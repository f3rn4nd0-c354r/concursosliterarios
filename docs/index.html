<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úí Concursos Liter√°rios em Portugu√™s</title>

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.0/dist/bootstrap-vue.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="app">
        <h1 class="page-title">Concursos Liter√°rios em Portugu√™s ‚úí</h1>
        <b-container id="top">
            <b-row>
                <b-col id="table-filter">
                    <!-- Content for the first div (takes up half of the screen on medium and larger screens) -->
                    Filtrar por
                    <ul>
                        <li>
                            <p> idade: tenho &nbsp;<input v-model="ageFilter" type="text" class="form-contro">&nbsp;
                                anos.
                            </p>
                        </li>
                        <li>
                            <p> formato: escrevo &nbsp; </p>
                            
                                <p class="writing-options">
                                    <b-form-radio-group id="writing-format" v-model="formatFilter"
                                        name="format-filter-selector" inline>
                                        <b-form-radio value="tudo" inline>tudo</b-form-radio>
                                        <b-form-radio value="prosa" inline>prosa</b-form-radio>
                                        <b-form-radio value="poesia" inline>poesia</b-form-radio>
                                    </b-form-radio-group>
                                </p>
                                <p class="writing-options"  >
                                    <b-form-radio-group id="writing-genre" v-model="genreFilter"
                                        name="genre-filter-selector" inline>
                                        <b-form-radio value="tudo" inline>tudo</b-form-radio>
                                        <b-form-radio value="ficcao" inline>fic√ß√£o</b-form-radio>
                                        <b-form-radio value="naoficcao" inline>n√£o fic√ß√£o</b-form-radio>
                                    </b-form-radio-group>
                                </p>
                            
                        </li>
                    </ul>
                </b-col>
                <b-col id="contribute-data">
                    <!-- Content for the second div (takes up half of the screen on medium and larger screens) -->
                    <p>Se conhece algum concurso que n√£o aparece na lista, indique-nos <a
                            href="https://forms.gle/8CUyHjLePvtXu1T58" target="_blank">aqui</a>.</p>
                    <p></p>
                    <p></p>
                    <p id="result-counter">{{ filteredUsuarios.length }} resultados</p>
                </b-col>
            </b-row>
        </b-container>

        <div id="separator">    </div>

        <b-table id="main-table" striped hover :items="filteredUsuarios" :fields="tableFields"
            :sort-by="currentSortColumn" label-sort-asc="Ordenar ü°Ö" label-sort-desc="Ordenar ü°á"
            label-sort-clear="desordenar" no-sort-reset class="table-striped" :sort-compare="sortingChanged" foot-clone>
            <template #cell(titulo)="data">
                <span v-html="data.item.titulo"></span>
            </template>
            <template #cell(website)="data">
                <b-link :href="data.item.website" target="_blank">ver website</b-link>
            </template>
            <template #cell(regulamento)="data">
                <b-link v-if="data.item.regulamento" :href="data.item.regulamento" target="_blank">ver regulamento</b-link>
            </template>
            <template #cell(prazo)="data">
                {{data.item.prazo}}
            </template>
            <template #cell(tempoRestante)="data">
                {{data.item.tempoRestante}} dias
            </template>
        </b-table>
    </div>


    <!-- Include the BootstrapVue app -->
    <script src="data.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    usuarios: usuarios,
                    ageFilter: '',
                    formatFilter: 'tudo',
                    genreFilter: 'tudo',
                    currentSortColumn: "prazo",
                    resultsConter: 0,
                    tableFields: [
                        { key: 'titulo', label: 'T√≠tulo', sortable: true, tdClass: 'no-splitting pre-wrap locked-column' },
                        { key: 'concorrente', label: 'Concorrente' },
                        { key: 'idade', label: 'Idade', tdClass: 'no-splitting' },
                        { key: 'obra', label: 'Requisitos da obra' },
                        { key: 'formato', label: 'Formato' },
                        { key: 'genero', label: 'G√©nero' },
                        { key: 'tema', label: 'Tema' },
                        { key: 'multiplas', label: 'M√∫ltiplas participa√ß√µes' },
                        { key: 'dimensao', label: 'Dimens√£o' },
                        { key: 'premio', label: 'Pr√©mio', sortable: true },
                        { key: 'entrega', label: 'Forma de entrega' },
                        { key: 'prazo', label: 'Prazo', sortable: true, tdClass: 'no-splitting' },
                        { key: 'tempoRestante', label: 'Faltam', sortable: true, thClass: 'no-splitting', tdClass: 'no-splitting' },
                        { key: 'obs', label: 'Obs.' },
                        { key: 'website', label: 'Website' },
                        { key: 'regulamento', label: 'Regulamento' },
                    ],
                };
            },
            methods: {
                sortingChanged(a, b, key) {
                    let newKey = key;
                    switch (key) {
                        case 'premio':
                            newKey = '1premio';
                            break;
                        // case 'idade':
                        //     newKey = 'id_max';
                        //     break;
                        default:
                            return false;
                    }
                    return a[newKey] - b[newKey];
                },
            },
            computed: {
                filteredUsuarios: function () {

                    usuarios.map(

                        item => {
                            // calculate days available to write
                            const pad = (n, s = 2) => (`${new Array(s).fill(0)}${n}`).slice(-s);

                            let d = new Date(item.prazo);
                            d.setHours(0, 0, 0, 0);
                            let dNow = new Date();
                            dNow.setHours(0, 0, 0, 0);
                            const diffTime = d - dNow;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            item.tempoRestante = diffDays;
                            // fomat prazo date
                            item.prazo = `${pad(d.getFullYear(), 4)}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

                            d = new Date(item.resultado);
                            if (!isNaN(d)) {
                                item.resultado = `${pad(d.getFullYear(), 4)}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
                            }

                            // convert sort key columns to int
                            for (column in ['id_max', "1premio"]) {
                                item.column = parseInt(item.column);
                            }

                            // 
                            item.titulo = item.titulo.replace('\n', '<br>');

                        }
                    )

                    return this.usuarios
                        .filter(usuario => {
                            // filter out contests that ended
                            let dToday = new Date();
                            dToday.setHours(0, 0, 0, 0);

                            if (new Date(usuario.prazo) < dToday) {
                                return false;
                            }
                            return true;
                        })

                        // age filter
                        .filter(usuario => {
                            if (!this.ageFilter) {
                                return true;
                            }

                            let minAge = parseInt(usuario.id_min) || 0;
                            let maxAge = parseInt(usuario.id_max) || 150;
                            let writerAge = parseInt(this.ageFilter);
                            return writerAge >= minAge && writerAge <= maxAge;
                        })

                        // format filter
                        .filter(usuario => {
                            results = usuarios;
                            if (this.formatFilter != "tudo") {
                                results = usuario.formato.toLowerCase().includes(this.formatFilter.toLowerCase());
                            }
                            return results;
                        })

                        // genre filter
                        .filter(usuario => {
                            results = usuarios;
                            let genres = usuario.genero.toLowerCase().split(',');
                            genres = genres.map((x) => x.trim());
                            if (this.genreFilter === "ficcao") {
                                results = (genres.indexOf('fic√ß√£o') > -1)
                            }
                            else if (this.genreFilter === "naoficcao") {
                                results = (genres.indexOf('n√£o fic√ß√£o') > -1)
                            }
                            return results;
                        })
                },
            }
        });
    </script>
</body>

</html>